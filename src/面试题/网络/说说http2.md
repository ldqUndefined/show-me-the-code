# 说说HTTP2

## HTTP/1存在的问题

队头阻塞，上一个请求还没返回，下一个请求不能发出。

TCP连接数限制，一个域名一般是6个TCP连接

报文头部太大切冗余

使用ASCII码，解析麻烦

## HTTP2特点

- 兼容HTTP/1
- 头部压缩(用伪头字段替换了起始行。:authority代表域名，:method代表方法，:status代表状态码。使用HPACK提高压缩率，静态表，动态表)
- 二进制格式(把原来的Header+Body)改成数个小片的二进制帧Frame，用Headers Frame放投书局，Data Frame放实体数据。
- 虚拟“流”，即二进制帧的双向传输序列。同一个TCP连接上并发多个“流”，实现了多路复用，解决了应用层层面的队头阻塞。单个“流”内帧是有序的，流之间的帧是无序的。流还实现了服务器推送和流量控制。
- 强化安全，http2“事实上”都跑在tls上

## 流与多路复用

**流是二进制帧的双向传输序列**

HTTP/2的连接中，帧在总体上是**”乱序收发“**的，因为是不同的流的帧交替着收发，但是对于拥有相同流ID的帧，在这个流内是有严格的先后顺序的，也就是流与流之间的帧是乱序的，但同个流内的帧是有序的。一个HTTP/2的流等于HTTP/1里的“请求-应答”。

流的特点：

- 流是可并发的，一个 HTTP/2 连接上可以同时发出多个流传输数据，也就是并发多请求，实现“多路复用”；
- 客户端和服务器都可以创建流，双方互不干扰；
- 流是双向的，一个流里面客户端和服务器都可以发送或接收数据帧，也就是一个“请求 - 应答”来回；
- 流之间没有固定关系，彼此独立，但流内部的帧是有严格顺序的；
- 流可以设置优先级，让服务器优先处理，比如先传 HTML/CSS，后传图片，优化用户体验；
- 流 ID 不能重用，只能顺序递增，客户端发起的 ID 是奇数，服务器端发起的 ID 是偶数；
- 在流上发送“RST_STREAM”帧可以随时终止流，取消接收或发送；
- 第 0 号流比较特殊，不能关闭，也不能发送数据帧，只能发送控制帧，用于流量控制。

## 使用

在http报文中的头字段，使用

`Connection: upgrade`

`Upgrade: http/2`

使用Upgrade字段时一定要设置`Connection: upgrade`

如果服务端决定升级协议，会返回101 Switching Protocols ，然后在Upgrade中标识使用的协议



