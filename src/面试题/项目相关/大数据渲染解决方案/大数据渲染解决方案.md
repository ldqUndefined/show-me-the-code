# 项目中大数据渲染解决方案

## 5W路摄像头树形渲染

1. 与后端协商删减区域设备树字段，只保留最基础的id、名称、经纬度等信息，减少请求的体积，缩短请求时间
2. antd 3.x的树控件没有长列表，而antd4.x的树控件有长列表，所以使用antd官网推荐的迁移工具从3.x升级到4.x。使用了树控件后并关闭控件的动画，使得区域树组件的渲染 取数+渲染保持在1s内。
3. 地图框选组件在没使用长列表时，一旦地图放大倍数较小时，容易框选上万个摄像头，此时瞬间展示上万个摄像头也会导致卡顿，通过使用长列表优化后可以流畅渲染。

## 5W路摄像头地图标记渲染

1. 项目中使用leaflet进行地图业务功能的开发，在渲染摄像头数超过3K时应用明显观察到卡顿，经过调研后，选择使用开源社区中的leaflet.markercluster进行聚簇图标的渲染，原理是在图标距离较近且放大倍数较小时通过渲染一个“聚簇图标”代替渲染多个图标，从而减少了dom结点的生成和插入。而在增加放大倍数时，由于leaflet自带的不渲染窗口以外的标记而保证结点数量不多能顺畅渲染。
2. 在使用了聚簇组件后，增加摄像头数量依旧发生卡顿，5W路摄像头时卡顿长达10s，后通过chrome开发面板的performance面板进行性能分析，发现并不是渲染dom结点导致的渲染卡顿，并且发现一个持续调用10s的方法频繁触发新生代垃圾回收(minor GC)，通过查看调用的方法发现这是一个将摄像头数组映射为地图标记数组的方法，由于在映射的过程中需要对数据进行操作，所以使用了reduce，但是由于每次都返回一个新的数组引用，在数据量大时需要不断地对数组进行浅拷贝并且丢弃当前迭代的数组的引用，从而导致新生代堆内存频繁到达需要垃圾回收的临界点而触发垃圾回收，从而引起了卡顿。通过修改reduce方法的返回值，每次都在相同的引用上进行push操作并返回相同的引用，减少了不必要的赋值过程和减少不必要的堆内存消耗，将地图标记的方法的执行时间由10S降低到了100ms。相当于从O(n2)优化到了O(n)。



