# 项目中最大的挑战及你认为的亮点

## 最大的挑战：gitlab构建

### 问题出现：what

推荐其他项目使用hard-source-webpack-plugin，但是偶现构建时间不减反增的情况。

首先我自己在项目中引入这个插件之前是在本地测过速的，确实提升了构建速度之后才提交代码，并且在自己的gitlab仓库的流水线构建中，也是减少构建时间也都是没有问题的。

### 问题分析：how

而引入了这个插件之后构建速度有影响的项目，经gitlab流水线日志的分析，确实是读缓存失败，导致了构建速度变慢，然后分析了他们的项目组成，他们的项目中多有个定制化的分支，分支不同由于需求的不同代码也差异较大，但是他们提交后都在同一个构建环境中进行构建，由于他们配置了并行构建模式，并且环境中有多个runner，然后我发现他们不同的分支是有可能被gitlab-runner拉到同一个文件夹下执行构建的，这样两个不同项目之间就共用了缓存，在两个项目中切换时就导致了缓存失效。而之所以会用到相同的gitlab-runner，是因为他们的job都配置了相同的tag，导致gitlab-runner空闲后就会拉去对应的job执行。

### 问题解决：do

于是找到了云平台组，让他们提供了不同的gitlab-runner的tag，然后在不同的分支中使用不同的tag，这样不同定制化的代码就不会被拉到同样的文件夹下进行构建，就可以准确命中缓存，提高构建速度了。

### 结尾思考：why

这个问题的主要原因就是对gitlab流水线的构建过程不清晰导致的，因为我在本地构建的时候都是同一份代码，所以构建时候都能命中缓存。但是当我们将代码提交到gitlab时，gitlab的构建是将代码按照一定的策略拉到特定的工作区进行构建，所以这就有不同代码使用同一份工作区和缓存的情况发生，而为了避免这种情况发生，我们就需要选择一定的策略将代码将不同的代码拉到不同工作区。

额外：在解决问题的过程中google时候并没有找到说gitlab构建或者这个插件有人出现过类似的问题，这也是由于我们的仓库分支比较特殊造成的所以没有遇到别人也有这个问题，我们在同一仓库下进行多个并线主线且差异很大的开发跟正常开发的仓库场景不同。

## 最大挑战：接入第三方地图

### 问题出现：

正常的地图开发都是使用的地图的标准坐标系，没有经过转换，都是地图配置好的，而有个需要要求接入现场已部署的一个非标准的只有深圳地图的坐标系的地图瓦片，并且他们地图平台提供了一个地图的JSSDK，并且给的文档也是使用那个SDK进行开发。而我们项目中地图是使用leaflet并且已经在上面进行了一些业务的开发了，如果替换别的地图组件，对原有业务有较大影响。我们希望不通过引入他们的SDK而直接直接使用他们提供的地图

### 问题分析：

通过调试他们的SDK，通过返回值得出了地图坐标系的一些基础信息，并且通过请求瓦片的图的url得出url的使用格式。

### 问题解决：

通过坐标系的基础信息，并通过查阅坐标系的转换方式，编写了一个自定义坐标写，通过修改默认的坐标系，成功使用了他们的地图瓦片。

### 结尾思考：

根据业务需求，学习涉及到的地图知识，并推动业务。

## 项目难点：

主要是：前端大量数据处理、渲染问题。

- 将计算耗时CPU密集的操作交给web worker，如将文件的MD5交给web worker执行，避免产生卡顿。
- 能分页的数据都分页处理，无法分页或者需求要求不能分页的引用长列表，现在antd的Tree支持长列表了，不支持的部分我们使用React-virtualized实现。
- 多层级可以异步加载的适用异步加载，在展开的时候去请求对应的数据
- 请求优化，对于长时间不变的大数据通过在前端增加缓存减少请求时间。请求后可以复用的数据存储在Redux中。
- 图片都适用懒加载，对于不在视口中的图片暂不显示，等进入视口后再加载

从请求、JS处理、DOM节点渲染3个方面优化

## 项目亮点：警务大数据平台实现应用中所有图片可拖拽搜索

在项目中负责人脸人体车辆的采集搜索部分、在这个模块中有一个搜索框，把图片拖拽到这个框中，就会根据拖拽的图片的特征值进行搜索，如果是拖动桌面图片文件的话，会有一个文件解析的过程，请求后台拿到对应图片的特征值后再走搜索流程。

项目中有许多模块和页面都有图片，客户可能想要对应用中其他模块看到的图片进行搜索，在之前用户需要手动保存对应图片，然后到搜索页面上传文件搜索。这样操作使用麻烦。

基于这个功能实现几个基础功能点。首先，封装了draggable组件和droppable组件，所有展示图片的地方都用draggable组件包裹一层，给组件传入图片相关信息，在拖拽时带上图片相关信息，在所有可放置的地方用droppable组件包裹一层，当拖动图片或者桌面图片文件放置时可以拿到图片特征值相关信息。并且由于应用中图片展示多，所以在draggable组件内又用图片懒加载包裹了一层。

在全局添加了一个图片暂存箱的功能模块，可以展开暂存箱，将图片拖动到这个模块“暂存”，然后到达搜索模块将图片拖动出来搜索，省去了用户保存图片并上传这个繁杂的流程，为搜索这个核心业务加速服务。

推动后台实现缩略图功能，提升页面的图片展示速度。



## 项目亮点：新算法接入前端无需额外开发

在之前每次新增算法，后台需要适配，并且给前端一个接口，让前端调用。但是这样每次新增算法的时候，前端都有重复的工作量，于是想要一个通用的方案来将算法的接入普适化。

让后端将算法的调用URL，及body，content-type返回，前端调用指定算法“试一试”功能时通过调用URL，带上content-type并将body中的关键字替换即可调用。这样后续新增算法，前端也没有额外的开发工作。

并且通过在算法中标识返回数据结构的类型，对响应值进行不同的处理，得出画框的数据，在图片上绘制目标框。

## 项目亮点：所有类分析任务统一管理

应用中有许多的分析任务需要后台分析不能马上得到结果，在统一管理之前，需要在当前页面轮询接口等待查询进度，或者同步loading阻塞操作等待结果返回，这样在每个页面都需要等待很影响交互。例如许多模块有结果导出、在线分析等，我们将其统一抽离到任务管理中心，对于所有的任务的创建，走后端统一接口通过一个特定的字段区分任务类型，由后端来分别处理每种case，并返回一个任务id，前端通过将其注册在任务中心里，使用这个id轮询查结果，对于不同类型的任务成功后可以进行的操作类型不同，比如导出任务可以点下载结果，对于任务分析可以点击跳转到对应的页面查看结果等，将应用中的分析类业务进行了统一管理。

